# This file was generated by the excavator check 'excavator/manage-circleci' as specified in .circleci/template.sh.
# To request a modification to the general template, file an issue on Excavator.
# To manually manage the CircleCI configuration for this project, remove the .circleci/template.sh file.

version: 2
jobs:
  build:
    docker:
      - image: circleci/openjdk:11-node-browsers
    steps:
      - checkout
      - restore_cache:
          name: Restore Yarn Package Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
      - restore_cache:
          name: Restore Gradle wrapper
          key: gradle-wrapper-v2-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
      - run: yarn install --non-interactive
      # Yarn's --frozen-lockfile option should do this, but it doesn't work in practice.
      - run:
          name: Check if yarn.lock changed
          command: git diff --exit-code
      - run: yarn build
      - deploy:
          command: |
            if echo "${CIRCLE_TAG}" | grep -Eq '[0-9]+(\.[0-9]+)+(-[a-zA-Z]+[0-9]*)*'; then
              yarn circle-publish
            fi
      - save_cache:
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - /root/project/node_modules
      - save_cache:
          key: 'gradle-wrapper-v2-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}'
          paths: [ ~/.gradle/wrapper ]

workflows:
  version: 2
  build:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
